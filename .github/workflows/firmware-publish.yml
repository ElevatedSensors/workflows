name: Publish Firmware

on:
  workflow_call:
    inputs:
      product-name:
        required: true
        type: string
      build-type:
        required: true
        type: string # "release" or "nightly"
    secrets:
      DOCS_REPO_TOKEN:
        required: true

jobs:
  get-release-summary:
    name: Get Release Summary
    runs-on: ubuntu-latest
    outputs:
      release-summary: ${{ steps.get-summary.outputs.release-summary }}
    steps:
      - id: get-summary
        run: |
          if [ "${{ inputs.build-type  }}" = "release" ]; then
            # head gets the first line, tr removes carriage return
            FIRST_LINE=$(echo "${{ github.event.release.body  }}" | head -n 1 | tr -d '\r')
            echo "release-summary=$FIRST_LINE" >> $GITHUB_OUTPUT
          else
            echo "release-summary=Nightly automated build for ${{ inputs.product-name }}" >> $GITHUB_OUTPUT
          fi

  build-firmware:
    name: Build Firmware
    needs: get-release-summary
    uses: esphome/workflows/.github/workflows/build.yml@2025.10.0
    with:
      files: |
        ${{ inputs.product-name }}.${{ inputs.build-type == 'release' && 'factory' || 'nightly' }}.yaml
      esphome-version: stable
      combined-name: ${{ inputs.product-name }}

      release-summary: ${{ needs.get-release-summary.outputs.release-summary }}

      release-url: ${{ inputs.build-type == 'release'
        && github.event.release.html_url
        || format('https://github.com/ElevatedSensors/{0}/releases/tag/nightly', inputs.product-name) }}

      release-version: ${{ inputs.build-type == 'release'
        && github.event.release.tag_name
        || 'nightly' }}

  upload-fw-to-release:
    name: Upload Firmware to Release
    needs: build-firmware
    uses: esphome/workflows/.github/workflows/upload-to-gh-release.yml@2025.10.0
    with:
      version: ${{ inputs.build-type == 'release'
        && github.event.release.tag_name
        || 'nightly' }}

  push-to-docs:
    name: Push Latest Firmware to Docs Repo
    if: inputs.build-type == 'release'
    needs: upload-fw-to-release
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Download release assets
        run: |
          mkdir -p firmware-download
          gh release download ${{ github.event.release.tag_name }} \
            --repo ${{ github.repository }} \
            --dir firmware-download \
            --clobber
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Clone docs repo
        run: |
          echo "what's in the folder(pre clone)"
          tree .
          echo "Cloning docs repo"
          git clone https://x-access-token:${{ secrets.DOCS_REPO_TOKEN }}@github.com/ElevatedSensors/docs.git docs-repo

      - name: Copy files to docs repo
        run: |
          FW_DIR="docs-repo/docs/firmware/${{ inputs.product-name }}"
          LATEST_DIR="$FW_DIR/latest"
          VERSION_DIR="$FW_DIR/${{ github.event.release.tag_name }}"

          # Copy to "latest" directory
          mkdir -p "$LATEST_DIR" # make dir if needed
          rm -rf "$LATEST_DIR"/* # remove old files
          cp -f firmware-download/* "$LATEST_DIR"/

          # Also copy to a versioned folder for history in docs
          mkdir -p "$VERSION_DIR"
          cp firmware-download/* "$VERSION_DIR"/

          echo "what's in the folder(post copy)"
          tree .

      - name: Create pull request in docs repo
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.DOCS_REPO_TOKEN }}
          path: docs-repo
          commit-message: |
            Update ${{ inputs.product-name }} firmware to ${{ github.event.release.tag_name }}
          title: "chore(firmware): update ${{ inputs.product-name }} to ${{ github.event.release.tag_name }}"
          body: |
            Automated update from ${{ inputs.product-name }} for release ${{ github.event.release.tag_name }}

            Release link: ${{ github.event.release.html_url }}
            Changelog: ${{ github.event.release.body }}
          branch: firmware-update-${{ inputs.product-name }}-${{ github.event.release.tag_name }}
          delete-branch: true
          draft: false
          assignees: stephenpapierski

  hubitat-bundle:
    name: Hubitat Bundle
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build bundle
        run: |
          BUNDLE_DIR="${{ inputs.product-name }}-bundle"
          mkdir "$BUNDLE_DIR"

          FILES="integrations/hubitat"
          PASCAL_NAME=$(echo "${{ inputs.product-name }}" | sed -r 's/(^|-)([a-z0-9])/\U\2/g')
          DRIVER_OUT="$BUNDLE_DIR/elevated_sensors.$PASCAL_NAME.groovy"
          VERSION="${{ inputs.build-type == 'release' && github.event.release.tag_name || 'nightly' }}"

          cp "$FILES/bundles/${{ inputs.product-name }}.txt" "$BUNDLE_DIR/install.txt"
          cp "$FILES/bundles/${{ inputs.product-name }}.txt" "$BUNDLE_DIR/update.txt"
          cp "$FILES/drivers/${{ inputs.product-name }}.groovy" "$DRIVER_OUT"
          sed -i "s/DRIVER_VERSION = \"dev\"/DRIVER_VERSION = \"$VERSION\"/g" "$DRIVER_OUT"
          wget -O "$BUNDLE_DIR/esphome.espHomeApiHelper.groovy" "https://raw.githubusercontent.com/bradsjm/hubitat-public/main/ESPHome/ESPHome-API-Library.groovy"

          zip -r "${{ inputs.product-name }}-hubitat-bundle.zip" "$BUNDLE_DIR"

          gh release upload "$VERSION" \
            "${{ inputs.product-name  }}-hubitat-bundle.zip" \
            "$BUNDLE_DIR/elevated_sensors.$PASCAL_NAME.groovy" \
            --clobber
        env:
          GH_TOKEN: ${{ github.token }}

  update-release-info:
    name: Update Release Info
    if: inputs.build-type == 'nightly'
    needs: [upload-fw-to-release, hubitat-bundle]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Ensures we have tags and history

      - name: Move Nightly Tag
        run: |
          # Force update local tag and push to remote
          git tag -f nightly
          git push origin nightly --force

      - name: Update Release Description
        run: |
          # Generate metadata
          BUILD_TIME=$(TZ=America/Denver date +"%Y-%m-%d %H:%M %Z")
          COMMIT_SHA="${{ github.sha }}"

          # Create a prominent warning and info body
          RELEASE_BODY=$(cat <<EOF
          ### ⚠️ Nightly Build
          This is an **automated rolling release** for testing purposes.

          - **Last Updated:** $BUILD_TIME
          - **Commit:** [$COMMIT_SHA](https://github.com/${{ github.repository }}/commit/$COMMIT_SHA)
          - **Stability:** Experimental/May contain bugs
          > [!IMPORTANT]
          > Files here are replaced every night and on every push to main
          EOF
          )

          # use gh cli to update the existing release
          gh release edit nightly --title "nightly" --notes "$RELEASE_BODY"
        env:
          GH_TOKEN: ${{ github.token }}
